<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koordinatkonverterare (Sverige + G√∂teborg)</title>
  <style>
    :root{
      --bg1:#0f1733;  /* ljusare √§n tidigare */
      --bg2:#121f44;
      --card:rgba(22,32,68,.92);
      --text:#e8ecff;
      --muted:#b7c0ff;
      --line:#2f3a72;
      --ok:#9be7a6;
      --warn:#ffd38a;
      --err:#ffb3b3;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 700px at 15% -10%, #1a2a66 0%, transparent 60%),
                 linear-gradient(180deg,var(--bg2),var(--bg1));
      color:var(--text);
    }
    .wrap{max-width:1040px;margin:0 auto;padding:20px}
    h1{font-size:20px;margin:0 0 10px}
    .sub{color:var(--muted);margin:0 0 16px;line-height:1.45}
    .grid{display:grid;gap:14px}
    @media(min-width:920px){ .grid{grid-template-columns:1.2fr .8fr} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.30)
    }
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    select,input,textarea,button{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0c1330;
      color:var(--text);
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:130px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:560px){ .row{grid-template-columns:1fr 1fr} }
    .row3{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){ .row3{grid-template-columns:1fr 1fr 1fr} }
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer}
    button.primary{background:#22337a}
    button.ghost{background:transparent}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      background:#0c1330;border:1px solid var(--line);
      padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted)
    }
    .pill.ok{color:var(--ok)}
    .pill.warn{color:var(--warn)}
    .pill.err{color:var(--err)}
    .out{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:13px;line-height:1.5;
      background:#0c1330;border:1px dashed #44519a;border-radius:14px;
      padding:12px;white-space:pre-wrap;word-break:break-word
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:#0c1330;color:var(--muted);cursor:pointer;font-size:12px
    }
    .tab.active{background:#22337a;color:var(--text)}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.45}
    details{margin-top:10px}
    summary{cursor:pointer;color:var(--text)}
    .small{font-size:12px;color:var(--muted);margin:8px 0 0;line-height:1.45}
    a{color:#c7d4ff}
    code.k{background:#0a1026;border:1px solid var(--line);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Koordinatkonverterare (Sverige + G√∂teborg)</h1>
    <p class="sub">
      St√∂d f√∂r WGS84 (lat/lon), SWEREF 99 TM, SWEREF 99 zoner (inkl. G√∂teborg: SWEREF 99 12 00 / EPSG:3007),
      RT90 2.5 gon V samt UTM/WebMercator. <br>
      Extra: H√∂jdomr√§kning GH88 ‚Üî RH2000 (skift 9,953 m).
    </p>

    <div class="grid">
      <div class="card">
        <div class="tabs">
          <button class="tab active" id="tabSingle">En punkt</button>
          <button class="tab" id="tabBatch">Batch</button>
        </div>

        <!-- SINGLE -->
        <div id="panelSingle">
          <div class="row">
            <div>
              <label for="fromCrs">Fr√•n koordinatsystem (plan)</label>
              <select id="fromCrs"></select>
            </div>
            <div>
              <label for="toCrs">Till koordinatsystem (plan)</label>
              <select id="toCrs"></select>
            </div>
          </div>

          <div class="row">
            <div>
              <label id="aLabel" for="aVal">Lat (N)</label>
              <input id="aVal" inputmode="decimal" placeholder="t.ex. 57.707233 eller 57 42 26.0" />
            </div>
            <div>
              <label id="bLabel" for="bVal">Lon (E)</label>
              <input id="bVal" inputmode="decimal" placeholder="t.ex. 11.967017 eller 11 58 1.3" />
            </div>
          </div>

          <div class="row3">
            <div>
              <label for="hVal">H√∂jd (m) (valfri)</label>
              <input id="hVal" inputmode="decimal" placeholder="t.ex. 12.34" />
            </div>
            <div>
              <label for="fromH">Fr√•n h√∂jdsystem</label>
              <select id="fromH"></select>
            </div>
            <div>
              <label for="toH">Till h√∂jdsystem</label>
              <select id="toH"></select>
            </div>
          </div>

          <div class="btnrow">
            <button class="primary" id="btnConvert">Konvertera</button>
            <button class="ghost" id="btnSwap">Byt fr√•n/till</button>
            <button class="ghost" id="btnClear">Rensa</button>
            <button class="ghost" id="btnCopy">Kopiera resultat</button>
          </div>

          <details>
            <summary>Avancerat: G√∂teborg (plan, √§ldre lokalt)</summary>
            <p class="small">
              V√§lj ‚ÄúG√∂teborg (plan, √§ldre lokalt)‚Äù i listan om du vill. F√∂r att kunna konvertera beh√∂ver appen en
              Proj4-definition f√∂r det lokala systemet (den varierar och √§r inte generellt standardiserad).
              Klistra in definitionen nedan och tryck ‚ÄúSpara‚Äù.
            </p>
            <label for="gbgOldDef">Proj4-definition (f√∂r G√∂teborg √§ldre lokalt)</label>
            <textarea id="gbgOldDef" placeholder="+proj=tmerc ... (din definition h√§r)"></textarea>
            <div class="btnrow">
              <button class="primary" id="btnSaveOld">Spara definition</button>
              <button class="ghost" id="btnClearOld">Rensa definition</button>
            </div>
            <p class="small">
              Tips: Om din milj√∂ blockerar CDN kan du ladda ner proj4 och l√§gga lokalt (t.ex. <code class="k">proj4.min.js</code>) och peka script-taggen dit.
            </p>
          </details>

          <p class="hint">
            F√∂r projicerade system: mata in <span class="pill">N</span> och <span class="pill">E</span>.
            F√∂r WGS84: <span class="pill">Lat</span> och <span class="pill">Lon</span>.
          </p>
        </div>

        <!-- BATCH -->
        <div id="panelBatch" style="display:none">
          <div class="row">
            <div>
              <label for="fromCrsB">Fr√•n koordinatsystem (plan)</label>
              <select id="fromCrsB"></select>
            </div>
            <div>
              <label for="toCrsB">Till koordinatsystem (plan)</label>
              <select id="toCrsB"></select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="fromHB">Fr√•n h√∂jdsystem</label>
              <select id="fromHB"></select>
            </div>
            <div>
              <label for="toHB">Till h√∂jdsystem</label>
              <select id="toHB"></select>
            </div>
          </div>

          <label for="batchIn">Indata (en punkt per rad)</label>
          <textarea id="batchIn" placeholder="Projicerat: N E [H]
6400000 320000 12.3

WGS84: Lat Lon [H]
57.707233 11.967017 12.3"></textarea>

          <div class="btnrow">
            <button class="primary" id="btnConvertBatch">Konvertera batch</button>
            <button class="ghost" id="btnCopyBatch">Kopiera utdata</button>
            <button class="ghost" id="btnClearBatch">Rensa</button>
          </div>

          <p class="hint">Separatorer: mellanslag, tab, komma eller semikolon.</p>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div class="pill warn" id="statusPill">Laddar proj4‚Ä¶</div>
          <div class="pill" id="mapPill" style="display:none">
            <a id="mapLink" href="#" target="_blank" rel="noopener">√ñppna i Google Maps</a>
          </div>
        </div>

        <label>Resultat</label>
        <div class="out" id="out">‚Äî</div>

        <div class="hint">
          ‚ÄúWGS84 (kontroll)‚Äù visar samma position i decimalgrader + DMS.
          H√∂jd omr√§knas endast om du anger ett H-v√§rde och v√§ljer h√∂jdsystem.
        </div>
      </div>
    </div>
  </div>

  <!-- Proj4 (CDN). Om din milj√∂ blockerar CDN: byt till lokal fil. -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js" onload="window.__proj4Loaded = true"></script>

  <script>
    // ===== Data =====
    const CRS = [
      { code:"EPSG:4326", name:"WGS84 (lat/lon)", type:"geographic" },
      { code:"EPSG:3006", name:"SWEREF 99 TM (EPSG:3006)", type:"projected" },
      { code:"EPSG:3007", name:"SWEREF 99 12 00 (G√∂teborg) (EPSG:3007)", type:"projected" },
      { code:"EPSG:3008", name:"SWEREF 99 13 30 (EPSG:3008)", type:"projected" },
      { code:"EPSG:3009", name:"SWEREF 99 15 00 (EPSG:3009)", type:"projected" },
      { code:"EPSG:3010", name:"SWEREF 99 16 30 (EPSG:3010)", type:"projected" },
      { code:"EPSG:3011", name:"SWEREF 99 18 00 (EPSG:3011)", type:"projected" },
      { code:"EPSG:3021", name:"RT90 2.5 gon V (EPSG:3021)", type:"projected" },
      { code:"EPSG:32633", name:"WGS84 / UTM zone 33N (EPSG:32633)", type:"projected" },
      { code:"EPSG:32632", name:"WGS84 / UTM zone 32N (EPSG:32632)", type:"projected" },
      { code:"EPSG:3857", name:"Web Mercator (EPSG:3857)", type:"projected" },

      // Nytt: G√∂teborg (plan, √§ldre lokalt) ‚Äì kr√§ver att du klistrar in proj4-definition
      { code:"GOT:OLD", name:"G√∂teborg (plan, √§ldre lokalt) (kr√§ver definition)", type:"projected_custom" },
    ];

    const HEIGHT = [
      { code:"none", name:"Ingen / l√§mna of√∂r√§ndrat" },
      { code:"RH2000", name:"RH2000" },
      { code:"GH88", name:"GH88 (G√∂teborg, √§ldre)" },
    ];
    const GH88_TO_RH2000 = 9.953; // RH2000 = GH88 - 9.953

    // ===== Helpers/UI =====
    const $ = (id) => document.getElementById(id);
    const statusPill = $("statusPill");
    const out = $("out");
    const mapPill = $("mapPill");
    const mapLink = $("mapLink");

    function setStatus(msg, kind="warn"){
      statusPill.textContent = msg;
      statusPill.classList.remove("ok","warn","err");
      statusPill.classList.add(kind);
    }

    function fillSelect(sel, items, defaultCode){
      sel.innerHTML = "";
      items.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.code;
        opt.textContent = c.name;
        sel.appendChild(opt);
      });
      sel.value = defaultCode || items[0].code;
    }

    function getCrs(code){
      const c = CRS.find(x => x.code === code);
      if(!c) throw new Error("Ok√§nt CRS: " + code);
      return c;
    }

    function updateLabels(fromCode){
      const from = getCrs(fromCode);
      if(from.type === "geographic"){
        $("aLabel").textContent = "Lat (N)";
        $("bLabel").textContent = "Lon (E)";
        $("aVal").placeholder = "t.ex. 57.707233 eller 57 42 26.0";
        $("bVal").placeholder = "t.ex. 11.967017 eller 11 58 1.3";
      } else {
        $("aLabel").textContent = "N (northing)";
        $("bLabel").textContent = "E (easting)";
        $("aVal").placeholder = "t.ex. 6400000.00";
        $("bVal").placeholder = "t.ex. 320000.00";
      }
    }

    function parseNumberFlexible(s){
      if(!s) return NaN;
      return Number(String(s).trim().replace(",", "."));
    }

    function parseAngleFlexible(s){
      s = String(s || "").trim();
      if(!s) return NaN;
      const n = parseNumberFlexible(s);
      if(Number.isFinite(n)) return n;

      const cleaned = s
        .replace(/[¬∞¬∫]/g," ")
        .replace(/[‚Ä≤']/g," ")
        .replace(/[‚Ä≥"]/g," ")
        .replace(/[NSEW]/gi," ")
        .replace(/,/g,".")
        .trim();

      const parts = cleaned.split(/\s+/).filter(Boolean).map(x => Number(x));
      if(parts.length === 0 || parts.some(x => !Number.isFinite(x))) return NaN;

      const deg = parts[0];
      const min = parts.length > 1 ? parts[1] : 0;
      const sec = parts.length > 2 ? parts[2] : 0;

      const sign = deg < 0 ? -1 : 1;
      const abs = Math.abs(deg) + (min/60) + (sec/3600);
      return sign * abs;
    }

    function toDMS(deg){
      const sign = deg < 0 ? -1 : 1;
      let a = Math.abs(deg);
      const d = Math.floor(a);
      a = (a - d) * 60;
      const m = Math.floor(a);
      const s = (a - m) * 60;
      const dd = sign < 0 ? -d : d;
      return `${dd}¬∞ ${m}' ${s.toFixed(3)}"`;
    }

    function toProjInput(crs, a, b){
      if(crs.type === "geographic"){
        const lat = a, lon = b;
        return [lon, lat];
      } else {
        const N = a, E = b;
        return [E, N];
      }
    }

    function fromProjOutput(crs, xy){
      if(crs.type === "geographic"){
        const lon = xy[0], lat = xy[1];
        return { lat, lon };
      } else {
        const E = xy[0], N = xy[1];
        return { N, E };
      }
    }

    function formatOut(target, obj){
      if(target.type === "geographic"){
        return `Lat: ${obj.lat.toFixed(8)}\n     DMS: ${toDMS(obj.lat)}\nLon: ${obj.lon.toFixed(8)}\n     DMS: ${toDMS(obj.lon)}`;
      }
      return `N: ${obj.N.toFixed(3)}\nE: ${obj.E.toFixed(3)}`;
    }

    function convertHeight(h, fromH, toH){
      if(!Number.isFinite(h)) return NaN;
      if(fromH === "none" || toH === "none" || fromH === toH) return h;
      if(fromH === "GH88" && toH === "RH2000") return h - GH88_TO_RH2000;
      if(fromH === "RH2000" && toH === "GH88") return h + GH88_TO_RH2000;
      return NaN;
    }

    function heightBlock(hIn, fromH, hOut, toH){
      if(!Number.isFinite(hIn)) return "";
      if(fromH === "none" || toH === "none") return `\nüèîÔ∏è H√∂jd: ${hIn.toFixed(3)} m (ingen omr√§kning)\n`;
      if(Number.isFinite(hOut)){
        return `\nüèîÔ∏è H√∂jd\nH (${fromH}): ${hIn.toFixed(3)} m\nH (${toH}): ${hOut.toFixed(3)} m\n`;
      }
      return `\nüèîÔ∏è H√∂jd: (kunde inte r√§kna om f√∂r ${fromH} ‚Üí ${toH})\n`;
    }

    // ===== Proj4 init (robust) =====
    let proj4Ready = false;

    function ensureProj4OrThrow(){
      if(!window.proj4) throw new Error("Proj4 kunde inte laddas. Om CDN blockeras: l√§gg proj4.js lokalt och peka script-taggen dit.");
      if(!proj4Ready) initProj4Defs();
    }

    function initProj4Defs(){
      if(proj4Ready) return;

      // Standarddefs
      proj4.defs("EPSG:3006", "+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:3007", "+proj=tmerc +lat_0=0 +lon_0=12 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:3008", "+proj=tmerc +lat_0=0 +lon_0=13.5 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:3009", "+proj=tmerc +lat_0=0 +lon_0=15 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:3010", "+proj=tmerc +lat_0=0 +lon_0=16.5 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:3011", "+proj=tmerc +lat_0=0 +lon_0=18 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:3021", "+proj=tmerc +lat_0=0 +lon_0=15.8082777777778 +k=1 +x_0=1500000 +y_0=0 +ellps=bessel +towgs84=414.1,41.3,603.1,-0.855,2.141,-7.023,0 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:32633", "+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:32632", "+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs +type=crs");
      proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs +type=crs");
      proj4.defs("EPSG:3857", "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs +type=crs");

      // Ladda ev sparad G√∂teborg-OLD-definition
      const saved = localStorage.getItem("gbg_old_proj4_def");
      if(saved && saved.trim()){
        try { proj4.defs("GOT:OLD", saved.trim()); }
        catch { /* hanteras vid konvertering */ }
      }

      proj4Ready = true;
      setStatus("Redo", "ok");
    }

    function ensureOldDefinedIfUsed(fromCode, toCode){
      const usesOld = (fromCode === "GOT:OLD" || toCode === "GOT:OLD");
      if(!usesOld) return;

      const def = localStorage.getItem("gbg_old_proj4_def") || "";
      if(!def.trim()){
        throw new Error("G√∂teborg (plan, √§ldre lokalt) saknar Proj4-definition. √ñppna 'Avancerat' och klistra in definitionen, spara och f√∂rs√∂k igen.");
      }
      // registrera om inte redan
      try { proj4.defs("GOT:OLD", def.trim()); }
      catch(e){ throw new Error("Proj4-definitionen f√∂r G√∂teborg (√§ldre lokalt) verkar ogiltig: " + (e?.message || e)); }
    }

    // ===== Compute =====
    function compute(){
      try{
        setStatus("Konverterar‚Ä¶", "warn");
        mapPill.style.display = "none";

        ensureProj4OrThrow();

        const fromCode = $("fromCrs").value;
        const toCode = $("toCrs").value;
        ensureOldDefinedIfUsed(fromCode, toCode);

        const from = getCrs(fromCode);
        const to = getCrs(toCode);

        const a = (from.type === "geographic") ? parseAngleFlexible($("aVal").value) : parseNumberFlexible($("aVal").value);
        const b = (from.type === "geographic") ? parseAngleFlexible($("bVal").value) : parseNumberFlexible($("bVal").value);
        if(!Number.isFinite(a) || !Number.isFinite(b)) throw new Error("Ogiltig indata. Kontrollera v√§rdena.");

        const inXY = toProjInput(from, a, b);
        const outXY = proj4(from.code, to.code, inXY);
        const outObj = fromProjOutput(to, outXY);

        const wgsXY = proj4(from.code, "EPSG:4326", inXY);
        const wgs = fromProjOutput(getCrs("EPSG:4326"), wgsXY);

        const hIn = parseNumberFlexible($("hVal").value);
        const fromH = $("fromH").value;
        const toH = $("toH").value;
        const hOut = convertHeight(hIn, fromH, toH);

        out.textContent =
`üéØ Till (plan): ${to.name}
${formatOut(to, outObj)}${heightBlock(hIn, fromH, hOut, toH)}
üß≠ WGS84 (kontroll)
${formatOut(getCrs("EPSG:4326"), wgs)}
`;
        setStatus("Klar", "ok");

        if(Number.isFinite(wgs.lat) && Number.isFinite(wgs.lon) && Math.abs(wgs.lat)<=90 && Math.abs(wgs.lon)<=180){
          mapLink.href = `https://www.google.com/maps?q=${encodeURIComponent(wgs.lat + "," + wgs.lon)}`;
          mapPill.style.display = "inline-flex";
        }
      }catch(e){
        out.textContent = "‚Äî";
        setStatus(e.message || "Fel", "err");
      }
    }

    function parseLine(line){
      return line.trim().split(/[,\s;]+/).filter(Boolean);
    }

    function computeBatch(){
      try{
        setStatus("Konverterar batch‚Ä¶", "warn");
        ensureProj4OrThrow();

        const fromCode = $("fromCrsB").value;
        const toCode = $("toCrsB").value;
        ensureOldDefinedIfUsed(fromCode, toCode);

        const from = getCrs(fromCode);
        const to = getCrs(toCode);

        const fromH = $("fromHB").value;
        const toH = $("toHB").value;

        const lines = $("batchIn").value.split(/\r?\n/);
        const outLines = [];
        outLines.push(`# from(plan): ${from.name}`);
        outLines.push(`# to(plan):   ${to.name}`);
        outLines.push(`# from(H): ${fromH}   to(H): ${toH}`);
        outLines.push("");

        let ok = 0;
        for(const ln of lines){
          if(!ln.trim()) continue;
          const cols = parseLine(ln);
          if(cols.length < 2){ outLines.push(`# skip: ${ln}`); continue; }

          const a = (from.type === "geographic") ? parseAngleFlexible(cols[0]) : parseNumberFlexible(cols[0]);
          const b = (from.type === "geographic") ? parseAngleFlexible(cols[1]) : parseNumberFlexible(cols[1]);
          if(!Number.isFinite(a) || !Number.isFinite(b)){ outLines.push(`# bad: ${ln}`); continue; }

          const inXY = toProjInput(from, a, b);
          const outXY = proj4(from.code, to.code, inXY);
          const obj = fromProjOutput(to, outXY);

          let hStr = "";
          if(cols.length >= 3){
            const hIn = parseNumberFlexible(cols[2]);
            if(Number.isFinite(hIn)){
              const hOut = convertHeight(hIn, fromH, toH);
              if(fromH==="none" || toH==="none" || fromH===toH) hStr = ` ${hIn.toFixed(3)}`;
              else if(Number.isFinite(hOut)) hStr = ` ${hOut.toFixed(3)}`;
              else hStr = ` NaN`;
            }
          }

          if(to.type === "geographic") outLines.push(`${obj.lat.toFixed(8)} ${obj.lon.toFixed(8)}${hStr}`);
          else outLines.push(`${obj.N.toFixed(3)} ${obj.E.toFixed(3)}${hStr}`);
          ok++;
        }

        out.textContent = outLines.join("\n");
        setStatus(`Klar (rader: ${ok})`, "ok");
        mapPill.style.display = "none";
      }catch(e){
        out.textContent = "‚Äî";
        setStatus(e.message || "Fel", "err");
      }
    }

    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); setStatus("Kopierat!", "ok"); }
      catch{ setStatus("Kunde inte kopiera (webbl√§sarbegr√§nsning).", "err"); }
    }

    function swapFromTo(){
      const a = $("fromCrs").value;
      $("fromCrs").value = $("toCrs").value;
      $("toCrs").value = a;
      updateLabels($("fromCrs").value);
    }

    // ===== Init UI first (s√• dropdowns alltid funkar) =====
    fillSelect($("fromCrs"), CRS, "EPSG:4326");
    fillSelect($("toCrs"), CRS, "EPSG:3007");
    fillSelect($("fromCrsB"), CRS, "EPSG:3007");
    fillSelect($("toCrsB"), CRS, "EPSG:4326");

    fillSelect($("fromH"), HEIGHT, "none");
    fillSelect($("toH"), HEIGHT, "none");
    fillSelect($("fromHB"), HEIGHT, "none");
    fillSelect($("toHB"), HEIGHT, "none");

    updateLabels($("fromCrs").value);
    $("fromCrs").addEventListener("change", () => updateLabels($("fromCrs").value));

    $("btnConvert").addEventListener("click", compute);
    $("btnSwap").addEventListener("click", swapFromTo);
    $("btnClear").addEventListener("click", () => {
      $("aVal").value=""; $("bVal").value=""; $("hVal").value="";
      $("fromH").value="none"; $("toH").value="none";
      out.textContent="‚Äî"; mapPill.style.display="none";
      setStatus("Redo", "ok");
    });
    $("btnCopy").addEventListener("click", () => copyText(out.textContent));

    $("btnConvertBatch").addEventListener("click", computeBatch);
    $("btnCopyBatch").addEventListener("click", () => copyText(out.textContent));
    $("btnClearBatch").addEventListener("click", () => {
      $("batchIn").value="";
      $("fromHB").value="none"; $("toHB").value="none";
      out.textContent="‚Äî"; setStatus("Redo", "ok");
    });

    // Tabs
    $("tabSingle").addEventListener("click", () => {
      $("tabSingle").classList.add("active"); $("tabBatch").classList.remove("active");
      $("panelSingle").style.display = ""; $("panelBatch").style.display = "none";
      out.textContent="‚Äî"; mapPill.style.display="none"; setStatus("Redo", "ok");
    });
    $("tabBatch").addEventListener("click", () => {
      $("tabBatch").classList.add("active"); $("tabSingle").classList.remove("active");
      $("panelBatch").style.display = ""; $("panelSingle").style.display = "none";
      out.textContent="‚Äî"; mapPill.style.display="none"; setStatus("Redo", "ok");
    });

    // Save/clear G√∂teborg-old proj4 definition
    $("btnSaveOld").addEventListener("click", () => {
      const def = ($("gbgOldDef").value || "").trim();
      localStorage.setItem("gbg_old_proj4_def", def);
      setStatus(def ? "Sparade G√∂teborg (√§ldre) definition" : "Sparade (tom) ‚Äì ingen definition", def ? "ok" : "warn");
      // Om proj4 finns, f√∂rs√∂k registrera direkt
      if(window.proj4 && def){
        try{ proj4.defs("GOT:OLD", def); proj4Ready = true; }
        catch(e){ setStatus("Definitionen verkar ogiltig: " + (e?.message || e), "err"); }
      }
    });
    $("btnClearOld").addEventListener("click", () => {
      localStorage.removeItem("gbg_old_proj4_def");
      $("gbgOldDef").value = "";
      setStatus("Rensade G√∂teborg (√§ldre) definition", "ok");
    });

    // Prefill textarea from storage
    $("gbgOldDef").value = localStorage.getItem("gbg_old_proj4_def") || "";

    // Poll to see if proj4 loaded (CDN)
    (function waitProj4(){
      if(window.__proj4Loaded && window.proj4){
        try{ initProj4Defs(); }
        catch(e){ setStatus(e.message || "Proj4-init fel", "err"); }
        return;
      }
      // efter en stund: om den inte laddas, visa tydligt fel men l√•t UI vara
      setTimeout(() => {
        if(!window.proj4){
          setStatus("Proj4 kunde inte laddas (CDN blockeras?) ‚Äì dropdowns funkar men konvertering kr√§ver proj4.", "warn");
        }
      }, 1200);
    })();
  </script>
</body>
</html>
